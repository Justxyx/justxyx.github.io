---
title: Dpdk é—®é¢˜
author: xyx
date: 2025-09-29 13:33:00 +0800
categories: [justxyx, kernel]
tags:
math: true
---


### 1. å®‰è£…

```c
* (HEAD detached at v23.11.5)

cd ~/xx/dpdk_brige/dpdk
rm -rf build
meson setup build -Dmax_numa_nodes=1
ninja -C build
```


### 2. ç¯å¢ƒåŸºç¡€é…ç½®

```c
xm@xm:~/xx/dpdk_brige/dpdk$ cat /proc/meminfo |grep Huge
AnonHugePages:         0 kB
ShmemHugePages:        0 kB
FileHugePages:         0 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
Hugetlb:               0 kB
xm@xm:~/xx/dpdk_brige/dpdk$ free -g
              total        used        free      shared  buff/cache   available
Mem:              7           0           6           0           0           6
Swap:             1           0           1
xm@xm:~/xx/dpdk_brige/dpdk$ lscpu
Architecture:                         x86_64
CPU op-mode(s):                       32-bit, 64-bit
Byte Order:                           Little Endian
Address sizes:                        36 bits physical, 48 bits virtual
CPU(s):                               4
On-line CPU(s) list:                  0-3
Thread(s) per core:                   1
Core(s) per socket:                   4
Socket(s):                            1
NUMA node(s):                         1
Vendor ID:                            GenuineIntel
CPU family:                           6
Model:                                167
Model name:                           11th Gen Intel(R) Core(TM) i7-11700 @ 2.50GHz
Stepping:                             1
CPU MHz:                              2496.000
BogoMIPS:                             4992.00
Hypervisor vendor:                    KVM
Virtualization type:                  full
L1d cache:                            192 KiB
L1i cache:                            128 KiB
L2 cache:                             2 MiB
L3 cache:                             16 MiB
NUMA node0 CPU(s):                    0-3
Vulnerability Gather data sampling:   Unknown: Dependent on hypervisor status
Vulnerability Itlb multihit:          KVM: Mitigation: VMX unsupported
Vulnerability L1tf:                   Mitigation; PTE Inversion
Vulnerability Mds:                    Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown
Vulnerability Meltdown:               Mitigation; PTI
Vulnerability Mmio stale data:        Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown
Vulnerability Reg file data sampling: Not affected
Vulnerability Retbleed:               Vulnerable
Vulnerability Spec rstack overflow:   Not affected
Vulnerability Spec store bypass:      Vulnerable
Vulnerability Spectre v1:             Mitigation; usercopy/swapgs barriers and __user pointer sanitization
Vulnerability Spectre v2:             Mitigation; Retpolines; STIBP disabled; RSB filling; PBRSB-eIBRS Not affected; BHI Retpoline
Vulnerability Srbds:                  Not affected
Vulnerability Tsx async abort:        Not affected
Flags:                                fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx rdtscp lm constant_tsc nopl xtopology nonstop_tsc cpuid tsc_kn
                                      own_freq pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single pti
                                       fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid avx512f avx512dq rdseed adx smap clflushopt avx512cd avx512bw avx512vl xsaveopt xsavec dtherm arat pln pts
```

### 3. numa é—®é¢˜

```c
xm@xm:~/xx/dpdk_brige/dpdk$ numactl --hardware
available: 1 nodes (0)
node 0 cpus: 0 1 2 3
node 0 size: 7930 MB
node 0 free: 6466 MB
node distances:
node   0 
  0:  10 
xm@xm:~/xx/dpdk_brige/dpdk$ 
xm@xm:~/xx/dpdk_brige/dpdk$ 
xm@xm:~/xx/dpdk_brige/dpdk$ free -g
              total        used        free      shared  buff/cache   available
Mem:              7           0           6           0           0           6
Swap:             1           0           1
```


```c
===============================
       å• NUMA èŠ‚ç‚¹ç¤ºæ„å›¾
===============================

NUMA Node 0
+-------------------------------+
| CPU Cores: 0 1 2 3            |
|                               |
|   +-----------------------+   |
|   | Hugepages (DMA mem)   |   | <- DPDK åˆ†é…çš„å†…å­˜ï¼Œç½‘å¡ DMA ç›´æ¥è®¿é—®
|   +-----------------------+   |
|                               |
| Network Card (ens4)            | <- PCIe ç½‘å¡å±äºæœ¬ NUMA èŠ‚ç‚¹
+-------------------------------+

æ•°æ®æµç¤ºæ„ï¼š
CPU 0/1/2/3  <--->  Hugepages å†…å­˜  <--->  ç½‘å¡ DMA

ç‰¹ç‚¹ï¼š
- CPU è®¿é—®æœ¬åœ° NUMA å†…å­˜å»¶è¿Ÿä½
- ç½‘å¡ DMA buffer åœ¨æœ¬åœ° NUMA èŠ‚ç‚¹ï¼Œååæœ€é«˜
- PMD è½®è¯¢çº¿ç¨‹å›ºå®šç»‘å®š CPU æ ¸å¿ƒ
- RX/TX é˜Ÿåˆ—ç»‘å®šæœ¬åœ° CPU + å†…å­˜ + ç½‘å¡


===============================
       å¤š NUMA èŠ‚ç‚¹ç¤ºæ„å›¾
===============================

NUMA Node 0                     NUMA Node 1
+---------------------+         +---------------------+
| CPU Cores: 0 1      |         | CPU Cores: 2 3      |
| Hugepages mem       |         | Hugepages mem       |
| Network Card ens4   |         | Network Card ens5   |
+---------------------+         +---------------------+

æœ€ä½³è®¿é—®ï¼š
CPU(node0) -> Mem(node0) -> NIC(node0)   // å¿«
CPU(node1) -> Mem(node1) -> NIC(node1)   // å¿«

è·¨èŠ‚ç‚¹è®¿é—®ï¼ˆCPU(node0) -> Mem(node1) æˆ– NIC(node1)ï¼‰ä¼šå¢åŠ å»¶è¿Ÿ

```

DPDK åšçš„äº‹æƒ…ï¼š

1. æ£€æµ‹ CPU æ ¸å¿ƒå’Œ NUMA èŠ‚ç‚¹
2. æ£€æµ‹ç½‘å¡æ‰€åœ¨ NUMA èŠ‚ç‚¹
3. ä¸ºæ¯ä¸ª NUMA èŠ‚ç‚¹åˆ†é… Hugepages å†…å­˜
4. å°† PMD çº¿ç¨‹ç»‘å®šåˆ° CPU
5. å°† RX/TX é˜Ÿåˆ—å’Œå†…å­˜ç»‘å®šåˆ°ç½‘å¡æ‰€åœ¨ NUMA èŠ‚ç‚¹


### 4. å¤§é¡µå†…å­˜é—®é¢˜

```c
/*
 * =====================================================
 * DPDK å¤§é¡µå†…å­˜ï¼ˆHugepagesï¼‰è¯´æ˜
 * =====================================================
 *
 * 1. å®šä¹‰
 * --------
 * - Linux é»˜è®¤é¡µå¤§å°ï¼š4 KB
 * - Hugepagesï¼ˆå¤§é¡µï¼‰ï¼šé€šå¸¸ 2 MB æˆ–æ›´å¤§
 * - ä¼˜åŠ¿ï¼š
 *     - å‡å°‘é¡µè¡¨æ¡ç›®æ•°é‡
 *     - é™ä½ CPU TLBï¼ˆTranslation Lookaside Bufferï¼‰ç¼ºå¤±
 *     - æå‡å†…å­˜è®¿é—®æ•ˆç‡
 *
 * 2. ä¸ºä»€ä¹ˆ DPDK éœ€è¦ Hugepages
 * --------------------------------
 * - é«˜æ€§èƒ½æ•°æ®å¹³é¢éœ€è¦é›¶æ‹·è´ï¼ˆzero-copyï¼‰DMAï¼š
 *     - ç½‘å¡ç›´æ¥è®¿é—®å†…å­˜ï¼ˆRX/TX bufferï¼‰
 *     - éœ€è¦ç‰©ç†è¿ç»­çš„å†…å­˜é¡µï¼Œæ™®é€š 4 KB é¡µå®¹æ˜“ç¢ç‰‡åŒ–
 * 
 * - å‡å°‘å†…å­˜ç®¡ç†å¼€é”€ï¼š
 *     - é«˜é€Ÿè½®è¯¢æ¨¡å¼çš„ PMD çº¿ç¨‹éœ€è¦é¢‘ç¹è®¿é—®å¤§é‡ buffer
 *     - ä½¿ç”¨å¤§é¡µå‡å°‘é¡µè¡¨æŸ¥æ‰¾æ¬¡æ•°å’Œ TLB Miss
 *
 * - é…åˆ NUMA ä¼˜åŒ–ï¼š
 *     - æ¯ä¸ª NUMA èŠ‚ç‚¹åˆ†é… Hugepages
 *     - çº¿ç¨‹ã€ç½‘å¡ã€å†…å­˜æœ¬åœ°åŒ–ï¼Œé¿å…è·¨èŠ‚ç‚¹è®¿é—®
 *
 * 3. é…ç½® Hugepages ç¤ºä¾‹ï¼ˆå• NUMA èŠ‚ç‚¹ï¼‰
 * ----------------------------------------
 * // æŸ¥çœ‹å½“å‰ Hugepages é…ç½®
 * cat /proc/meminfo | grep Huge
 *
 * // è®¾ç½® 2 GB å†…å­˜ä¸º Hugepagesï¼ˆå‡è®¾é¡µå¤§å° 2 MBï¼‰
 * sudo sysctl -w vm.nr_hugepages=1024
 *
 * // ä¸º NUMA èŠ‚ç‚¹å•ç‹¬è®¾ç½®
 * echo 1024 | sudo tee /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
 *
 * 4. DPDK ä½¿ç”¨ Hugepages
 * ----------------------
 * sudo build/app/dpdk-testpmd -l 0-3 -n 1 -- --socket-mem 1024
 * - -l 0-3       : ä½¿ç”¨ CPU æ ¸å¿ƒ 0-3
 * - -n 1         : å†…å­˜é€šé“æ•°
 * - --socket-mem : æ¯ä¸ª NUMA èŠ‚ç‚¹åˆ†é…çš„ Hugepages å†…å­˜å¤§å°ï¼ˆMBï¼‰
 * 
 * DPDK ä¼šï¼š
 * - æ£€æµ‹ CPU æ ¸å¿ƒå’Œ NUMA èŠ‚ç‚¹
 * - æ£€æµ‹ç½‘å¡ NUMA èŠ‚ç‚¹
 * - åˆ†é… Hugepages å†…å­˜ï¼Œä½œä¸º DMA buffer
 * - å°† PMD çº¿ç¨‹ç»‘å®šåˆ° CPUï¼Œé˜Ÿåˆ—ç»‘å®šåˆ°ç½‘å¡æ‰€åœ¨ NUMA èŠ‚ç‚¹
 *
 * 5. æ€»ç»“
 * --------
 * - Hugepages æä¾›ç‰©ç†è¿ç»­å†…å­˜ï¼Œé™ä½é¡µè¡¨/TLBå¼€é”€
 * - å¿…é¡»ä¸ NUMA é…åˆä¿è¯çº¿ç¨‹ã€å†…å­˜ã€ç½‘å¡æœ¬åœ°åŒ–
 * - DPDK ç¨‹åºåˆå§‹åŒ–å¤±è´¥ï¼ˆCannot get hugepage informationï¼‰é€šå¸¸æ„å‘³ç€
 *   Hugepages æœªåˆ†é…æˆ–æƒé™ä¸è¶³
 *
 */
```

### 5. igb_uio é—®é¢˜

```c
/*
 * igb_uio ä¸ DPDK çš„å…³ç³»
 *
 * 1ï¸âƒ£ igb_uio ä¸æ˜¯ç½‘å¡é©±åŠ¨
 * ----------------------------------------------------
 * - å‚å•†å†…æ ¸é©±åŠ¨ (i40e/igb/ixgbe)ï¼š
 *     * è´Ÿè´£ç½‘å¡æ”¶å‘
 *     * ä¾èµ–å†…æ ¸åè®®æ ˆ (TCP/IP)
 *
 * - DPDK ç”¨æˆ·æ€é©±åŠ¨ (PMDï¼Œä¾‹å¦‚ net_i40e/net_igb)ï¼š
 *     * è´Ÿè´£ç½‘å¡æ”¶å‘
 *     * å®Œå…¨åœ¨ç”¨æˆ·æ€å¤„ç†ï¼Œä¸èµ°å†…æ ¸åè®®æ ˆ
 *
 * - igb_uioï¼š
 *     * ä¸æ˜¯ç½‘å¡é©±åŠ¨
 *     * åªæ˜¯â€œæ¬è¿å·¥â€ï¼Œè´Ÿè´£æŠŠ PCI èµ„æºäº¤ç»™ç”¨æˆ·æ€
 *
 *
 * 2ï¸âƒ£ igb_uio çš„ä½œç”¨
 * ----------------------------------------------------
 * - è§£é™¤ç½‘å¡å’Œå†…æ ¸é©±åŠ¨ç»‘å®š (å¦‚ i40e/igb)
 * - æŠŠ PCI è®¾å¤‡ç»‘å®šåˆ° igb_uio
 * - é€šè¿‡ /dev/uioX æš´éœ²è®¾å¤‡èµ„æºç»™ç”¨æˆ·æ€ï¼š
 *     * BAR å¯„å­˜å™¨
 *     * MSI-X ä¸­æ–­
 *     * DMA åœ°å€ç©ºé—´
 * - ç”¨æˆ·æ€ PMD å¯ä»¥ç›´æ¥è®¿é—®ç½‘å¡å¯„å­˜å™¨å’Œ DMA å†…å­˜
 *
 *
 * 3ï¸âƒ£ ä¸ºä»€ä¹ˆ igb_uio èƒ½â€œé€‚é…æ‰€æœ‰ç½‘å¡â€ï¼Ÿ
 * ----------------------------------------------------
 * - ç½‘å¡ç¡¬ä»¶çš„å¯„å­˜å™¨/DMA è®¿é—®æ–¹å¼æ˜¯ç”± PCIe æ€»çº¿æš´éœ²çš„
 * - è¿™äº›æ“ä½œå’Œé©±åŠ¨æ¡†æ¶åˆ†ç¦»ï¼Œå±äºé€šç”¨è¡Œä¸º
 * - å› æ­¤ï¼š
 *     * igb_uio åªåšé€šç”¨ PCI â†’ ç”¨æˆ·æ€æ˜ å°„
 *     * ä¸å…³å¿ƒç½‘å¡å‹å·
 *     * å…·ä½“é€»è¾‘äº¤ç»™ DPDK PMD å®ç°
 *
 *   ä¸¾ä¾‹ï¼š
 *     - i40e ç½‘å¡ â†’ DPDK ä½¿ç”¨ net_i40e PMD
 *     - igb ç½‘å¡ â†’ DPDK ä½¿ç”¨ net_igb PMD
 *     - virtio ç½‘å¡ â†’ DPDK ä½¿ç”¨ net_virtio PMD
 *
 *
 * 4ï¸âƒ£ æ€»ç»“
 * ----------------------------------------------------
 * - igb_uio = é€šç”¨â€œç½‘å…³â€ï¼Œè´Ÿè´£ PCI â†’ ç”¨æˆ·æ€æ˜ å°„
 * - DPDK PMD = é’ˆå¯¹å…·ä½“ç½‘å¡å‹å·çš„â€œé©±åŠ¨å¤§è„‘â€
 * - å†…æ ¸é©±åŠ¨ (i40e/igb/ixgbe) ä¸ DPDK PMD äºŒé€‰ä¸€ï¼š
 *     * å†…æ ¸é©±åŠ¨ â†’ å†…æ ¸åè®®æ ˆ
 *     * igb_uio + PMD â†’ ç”¨æˆ·æ€é«˜é€Ÿæ”¶å‘
 */
```

### 6. why is dpdkï¼Ÿ

```c
/*
 * ============================================================
 * DPDK ç®€è¦è¯´æ˜ï¼ˆC æ³¨é‡Šç‰ˆï¼‰
 * ============================================================
 *
 * 1ï¸âƒ£ DPDK æ˜¯ä»€ä¹ˆï¼Ÿ
 * ------------------------------------------------------------
 * - DPDK (Data Plane Development Kit)
 * - ä¸€å¥—ç”¨æˆ·æ€é«˜é€Ÿç½‘ç»œåŒ…å¤„ç†æ¡†æ¶
 * - æ ¸å¿ƒæ€è·¯ï¼šç»•è¿‡å†…æ ¸åè®®æ ˆï¼Œç›´æ¥ç”¨ç”¨æˆ·æ€é©±åŠ¨ï¼ˆPMDï¼‰æ”¶å‘åŒ…
 *
 * ä¼ ç»Ÿæ–¹å¼ï¼ˆLinux å†…æ ¸ç½‘ç»œæ ˆï¼‰ï¼š
 *   [ ç½‘å¡ ] â†’ [ å†…æ ¸é©±åŠ¨ ] â†’ [ å†…æ ¸åè®®æ ˆ TCP/IP ] â†’ [ ç”¨æˆ·åº”ç”¨ ]
 *   -> æ¯æ”¶ä¸€ä¸ªåŒ…ï¼Œè¦ç»è¿‡å†…æ ¸å’Œç³»ç»Ÿè°ƒç”¨ï¼Œæ€§èƒ½å¼€é”€å¤§
 *
 * DPDK æ–¹å¼ï¼š
 *   [ ç½‘å¡ ] â†’ [ DPDK é©±åŠ¨ PMD + ç”¨æˆ·æ€åº”ç”¨ ]
 *   -> å†…æ ¸å®Œå…¨ç»•å¼€ï¼ŒCPU è½®è¯¢æ–¹å¼å¤„ç†ï¼Œæ•ˆç‡æ›´é«˜ï¼Œå¯è¾¾åˆ°æ•°åƒä¸‡ PPS
 *
 * 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¦ç”¨ DPDKï¼Ÿ
 * ------------------------------------------------------------
 * - æè‡´æ€§èƒ½ï¼šå°åŒ…è½¬å‘å¯åšåˆ°çº¿é€Ÿ (10G/25G/100G)
 * - å¯æ§æ€§å¼ºï¼šå¼€å‘è€…è‡ªå·±æŒæ¡å†…å­˜ç®¡ç†ã€è°ƒåº¦ç­–ç•¥
 * - å¹¿æ³›åº”ç”¨ï¼š
 *   - é˜²ç«å¢™ / WAF / IDS / IPS
 *   - è´Ÿè½½å‡è¡¡ / ä»£ç†ï¼ˆLVSã€HAProxy DPDK ç‰ˆï¼‰
 *   - 5G Coreã€vRAN
 *   - é‡‘èäº¤æ˜“ï¼ˆè¶…ä½å»¶è¿Ÿæ”¶å‘åŒ…ï¼‰
 *
 * 3ï¸âƒ£ ä¸šç•Œä¸€èˆ¬å¦‚ä½•ä½¿ç”¨ DPDKï¼Ÿ
 * ------------------------------------------------------------
 * ğŸ…°ï¸ ç›´æ¥å†™ DPDK åº”ç”¨ï¼ˆç¡¬æ ¸æ´¾ï¼‰
 *   - ä½¿ç”¨ DPDK API ç¼–ç¨‹ï¼š
 *       - æ”¶åŒ…: rte_eth_rx_burst
 *       - å‘åŒ…: rte_eth_tx_burst
 *   - é€‚åˆåšå®šåˆ¶åŒ–ç½‘ç»œåŠŸèƒ½ï¼ˆDPIã€é˜²ç«å¢™ã€SD-WANï¼‰
 *   - æ€§èƒ½æè‡´ï¼Œä½†å¼€å‘æˆæœ¬é«˜
 *
 * ğŸ…±ï¸ åŸºäº DPDK çš„æ¡†æ¶ï¼ˆä¸»æµæ´¾ï¼‰
 *   - å°è£…äº† DPDKï¼Œå¼€å‘æ›´æ–¹ä¾¿ï¼š
 *       - OVS-DPDK â†’ Open vSwitch DPDK åŠ é€Ÿç‰ˆ
 *       - VPP (FD.io) â†’ ç”¨æˆ·æ€è½¬å‘å¹³é¢
 *       - Snort/Suricata with DPDK â†’ å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
 *       - NGINX with DPDK patches â†’ é«˜é€Ÿä»£ç†
 *   - ä¼ä¸šå¸¸è§åšæ³•ï¼šåœ¨ OVS-DPDK æˆ– VPP ä¸Šè·‘ä¸šåŠ¡ï¼Œä¸è£¸å†™ DPDK
 *
 * ğŸ…¾ï¸ ç”¨äºç½‘ç»œæ€§èƒ½æµ‹è¯•ï¼ˆå­¦ä¹ /éªŒè¯ï¼‰
 *   - DPDK è‡ªå¸¦ testpmdï¼šéªŒè¯ç¯å¢ƒæ˜¯å¦å¯ç”¨ã€ç½‘å¡æ€§èƒ½
 *   - DPDK è‡ªå¸¦ pktgen-dpdkï¼šç”Ÿæˆæµé‡
 *   - é€‚åˆå­¦ä¹ å’Œç¯å¢ƒéªŒè¯
 *
 * 4ï¸âƒ£ å°ç»“
 * ------------------------------------------------------------
 * - DPDK = ç”¨æˆ·æ€æ”¶å‘åŒ…æ¡†æ¶ï¼Œç»•è¿‡å†…æ ¸ï¼ŒåŠ é€Ÿç½‘ç»œå¤„ç†
 * - ä¸šç•Œç”¨æ³•ï¼š
 *   - ç¡¬æ ¸å‹ï¼šè‡ªå·±å†™ DPDK åº”ç”¨ï¼ˆå®‰å…¨å‚å•†ã€é‡‘èï¼‰
 *   - æ¡†æ¶å‹ï¼šç”¨ OVS-DPDK / VPPï¼ˆäº‘å‚å•†ã€è¿è¥å•†ï¼‰
 *   - å·¥å…·å‹ï¼šç”¨ testpmd / pktgenï¼ˆç ”å‘ã€å®éªŒå®¤ï¼‰
 *
 * =============================================================
 * End of summary
 * =============================================================
 */

```

### 7. å†èŠ DPDK åº”ç”¨åœºæ™¯

```c
/*
 * ===========================================================
 * DPDK ç®€ä»‹ä¸ä½¿ç”¨ç¤ºä¾‹ï¼ˆC æ³¨é‡Šç‰ˆï¼‰
 * ===========================================================
 *
 * 1ï¸âƒ£ DPDK æœ¬è´¨
 *
 * DPDK = æ¡†æ¶ + ç”¨æˆ·æ€åº“ + PMD é©±åŠ¨
 * - é«˜æ€§èƒ½ç½‘ç»œåŒ…å¤„ç†çš„ C åº“
 * - C ç¨‹åºé€šè¿‡ #include <rte_*.h> å¼•ç”¨å¤´æ–‡ä»¶
 * - ç¼–è¯‘é“¾æ¥ DPDK åå³å¯ç›´æ¥è°ƒç”¨ API
 * - æ ¸å¿ƒæ€æƒ³ï¼šç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆï¼Œç”¨æˆ·æ€ç›´æ¥æ“ä½œç½‘å¡ DMA å†…å­˜
 *   CPU è½®è¯¢æ”¶å‘åŒ…ï¼Œæ€§èƒ½æé«˜
 *
 * -----------------------------------------------------------
 *
 * 2ï¸âƒ£ dpdk-testpmd ä¸è‡ªå·±å†™çš„ C ç¨‹åº
 *
 * - dpdk-testpmd æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª C ç¨‹åºäºŒè¿›åˆ¶
 * - è°ƒç”¨çš„éƒ½æ˜¯ DPDK å®˜æ–¹æä¾›çš„ APIï¼š
 *   - åˆå§‹åŒ– EAL
 *   - é…ç½®ç«¯å£å’Œé˜Ÿåˆ—
 *   - åˆ›å»ºå†…å­˜æ± 
 *   - æ”¶å‘åŒ…å¾ªç¯
 * - è‡ªå·±å†™çš„ç¨‹åºä¸ testpmd åŒç±»ï¼Œåªæ˜¯åŠŸèƒ½è‡ªå®šä¹‰
 *
 * -----------------------------------------------------------
 *
 * 3ï¸âƒ£ DPDK C ç¨‹åºä¼ªç ç¤ºä¾‹
 *
 * #include <rte_eal.h>
 * #include <rte_ethdev.h>
 * #include <rte_mbuf.h>
 *
 * int main(int argc, char **argv) {
 *     // 1. åˆå§‹åŒ– EALï¼ˆDPDK ç¯å¢ƒï¼‰
 *     rte_eal_init(argc, argv);
 *
 *     // 2. æŸ¥è¯¢å¯ç”¨ç½‘å¡æ•°é‡
 *     uint16_t nb_ports = rte_eth_dev_count_avail();
 *
 *     // 3. åˆ›å»º mbuf å†…å­˜æ± 
 *     struct rte_mempool *mbuf_pool = rte_pktmbuf_pool_create(
 *         "MBUF_POOL", 8192, 256, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id());
 *
 *     // 4. é…ç½®ç«¯å£ & é˜Ÿåˆ—
 *     for (int port_id = 0; port_id < nb_ports; port_id++) {
 *         rte_eth_dev_configure(port_id, 1, 1, NULL);
 *         rte_eth_rx_queue_setup(port_id, 0, 1024, rte_eth_dev_socket_id(port_id), NULL, mbuf_pool);
 *         rte_eth_tx_queue_setup(port_id, 0, 1024, rte_eth_dev_socket_id(port_id), NULL);
 *         rte_eth_dev_start(port_id);
 *     }
 *
 *     // 5. æ”¶å‘åŒ…ä¸»å¾ªç¯
 *     while (1) {
 *         struct rte_mbuf *pkts[32];
 *         int nb_rx = rte_eth_rx_burst(0, 0, pkts, 32);
 *         if (nb_rx > 0) {
 *             rte_eth_tx_burst(0, 0, pkts, nb_rx);
 *         }
 *     }
 *
 *     // 6. åœæ­¢ç«¯å£
 *     for (int port_id = 0; port_id < nb_ports; port_id++) {
 *         rte_eth_dev_stop(port_id);
 *         rte_eth_dev_close(port_id);
 *     }
 *
 *     return 0;
 * }
 *
 * -----------------------------------------------------------
 *
 * æ ¸å¿ƒ API å¿«è§ˆ
 *
 * åŠŸèƒ½          | API                        | è¯´æ˜
 * ------------------------------------------------------------
 * åˆå§‹åŒ– DPDK    | rte_eal_init()             | åˆå§‹åŒ– hugepagesã€NUMAã€CPU ç»‘å®š
 * æŸ¥è¯¢ç½‘å¡      | rte_eth_dev_count_avail()  | å¯ç”¨ç½‘å¡æ•°é‡
 * åˆ›å»ºå†…å­˜æ±     | rte_pktmbuf_pool_create()  | åˆ†é… mbuf å†…å­˜ç”¨äºæ”¶å‘åŒ…
 * é…ç½®ç«¯å£      | rte_eth_dev_configure()    | é…ç½® RX/TX é˜Ÿåˆ—æ•°é‡
 * é…ç½® RX é˜Ÿåˆ—  | rte_eth_rx_queue_setup()   | è®¾ç½® RX é˜Ÿåˆ—å‚æ•°
 * é…ç½® TX é˜Ÿåˆ—  | rte_eth_tx_queue_setup()   | è®¾ç½® TX é˜Ÿåˆ—å‚æ•°
 * å¯åŠ¨ç«¯å£      | rte_eth_dev_start()        | æ¿€æ´»ç«¯å£å¼€å§‹æ”¶å‘
 * æ”¶åŒ…          | rte_eth_rx_burst()         | æ‰¹é‡æ”¶åŒ…
 * å‘åŒ…          | rte_eth_tx_burst()         | æ‰¹é‡å‘åŒ…
 * åœæ­¢ç«¯å£      | rte_eth_dev_stop()         | åœæ­¢æ”¶å‘
 * å…³é—­ç«¯å£      | rte_eth_dev_close()        | é‡Šæ”¾ç«¯å£èµ„æº
 *
 * -----------------------------------------------------------
 *
 * ğŸ’¡ æ€»ç»“
 *
 * - DPDK = ç”¨æˆ·æ€é«˜æ€§èƒ½ç½‘ç»œåº“
 * - dpdk-testpmd = å®˜æ–¹ç¤ºä¾‹ç¨‹åºï¼Œè°ƒç”¨ API åšæ”¶å‘æµ‹è¯•
 * - è‡ªå·±å†™ C ç¨‹åº = åŒç†ï¼Œä¹Ÿè°ƒç”¨ APIï¼Œåªæ˜¯åŠŸèƒ½è‡ªå®šä¹‰
 */
```

### 8. DPDK é¢„å¤‡æµç¨‹ & å¯åŠ¨æµç¨‹

```c
/*
 * ================= DPDK å¯åŠ¨ä¸ testpmd æµç¨‹æ³¨é‡Š =================
 *
 * 1ï¸âƒ£ é¢„å¤‡æ­¥éª¤ï¼šç³»ç»Ÿ & é©±åŠ¨å‡†å¤‡
 *
 * Hugepagesï¼ˆå¤§é¡µå†…å­˜ï¼‰åˆ†é…
 * - DPDK PMD éœ€è¦è¿ç»­å¤§å—å†…å­˜ï¼ˆDMA bufferï¼‰æ¥æ”¾ mbuf
 * - ç¤ºä¾‹ï¼š
 *   echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
 * - å¯æŒ‰ NUMA èŠ‚ç‚¹åˆ†é…ï¼š
 *   echo 512 > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
 *   echo 512 > /sys/devices/system/node/node1/hugepages/hugepages-2048kB/nr_hugepages
 *
 * ç½‘å¡ç»‘å®šåˆ°ç”¨æˆ·æ€é©±åŠ¨
 * - å†…æ ¸é©±åŠ¨ä¸èƒ½åŒæ—¶è¢« DPDK ä½¿ç”¨
 * - ä½¿ç”¨ dpdk-devbind.py ç»‘å®šï¼š
 *   sudo ./usertools/dpdk-devbind.py -b igb_uio 0000:00:05.0
 * - ç»‘å®šå®Œæˆå PMD é©±åŠ¨æ‰èƒ½æ¢æµ‹åˆ°ç½‘å¡
 *
 * CPU & NUMA æ ¸å¿ƒè§„åˆ’ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
 * - ç¡®å®šå“ªäº›æ ¸å¿ƒç”¨äºè½®è¯¢çº¿ç¨‹ã€å“ªäº›æ ¸å¿ƒç•™ç»™ç³»ç»Ÿ
 * - é¿å…è·¨ NUMA èŠ‚ç‚¹è®¿é—®ï¼Œæé«˜ DMA é€Ÿåº¦
 *
 *
 * 2ï¸âƒ£ DPDK åº”ç”¨åˆå§‹åŒ–ï¼ˆä»¥ testpmd ä¸ºä¾‹ï¼‰
 *
 * // 1. åˆå§‹åŒ– EALï¼ˆEnvironment Abstraction Layerï¼‰
 * rte_eal_init(argc, argv); 
 * // ä½œç”¨ï¼š
 * // - è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆCPUæ©ç ã€NUMAèŠ‚ç‚¹ã€Hugepageç›®å½•ç­‰ï¼‰
 * // - åˆå§‹åŒ– Hugepages æ˜ å°„
 * // - åˆå§‹åŒ–ç”¨æˆ·æ€ PCI è®¿é—®
 * // - ç»‘å®š PMD é©±åŠ¨åˆ°ç½‘å¡
 *
 * // 2. æ¢æµ‹ç½‘å¡
 * uint16_t nb_ports = rte_eth_dev_count_avail();
 * // DPDK PMD é©±åŠ¨æŸ¥çœ‹ç»‘å®šçš„ç½‘å¡ï¼Œè®°å½• NUMA èŠ‚ç‚¹
 *
 * // 3. åˆ›å»º mbuf å†…å­˜æ± 
 * struct rte_mempool *mbuf_pool = rte_pktmbuf_pool_create(
 *     "MBUF_POOL", 8192, 256, 0, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id());
 * // - åˆ†é…å¤§é¡µå†…å­˜
 * // - æŒ‰ NUMA èŠ‚ç‚¹åˆ†é…
 *
 * // 4. é…ç½®ç«¯å£å’Œé˜Ÿåˆ—
 * for (port_id = 0; port_id < nb_ports; port_id++) {
 *     rte_eth_dev_configure(port_id, nb_rx_queues, nb_tx_queues, &conf);
 *     rte_eth_rx_queue_setup(port_id, ... , mbuf_pool);
 *     rte_eth_tx_queue_setup(port_id, ...);
 *     rte_eth_dev_start(port_id);
 * }
 *
 * // 5. ä¸»å¾ªç¯ï¼šè½®è¯¢æ”¶å‘åŒ…
 * while (!quit) {
 *     // æ”¶åŒ…
 *     nb_rx = rte_eth_rx_burst(port_id, queue_id, pkts, BURST_SIZE);
 *     // å‘åŒ…
 *     nb_tx = rte_eth_tx_burst(port_id, queue_id, pkts, nb_rx);
 * }
 *
 * // 6. åœæ­¢ç«¯å£
 * for (port_id = 0; port_id < nb_ports; port_id++) {
 *     rte_eth_dev_stop(port_id);
 *     rte_eth_dev_close(port_id);
 * }
 *
 *
 * 3ï¸âƒ£ æ ¸å¿ƒç‚¹è¯´æ˜
 *
 * ç¯èŠ‚            | ä½œç”¨                          | æ³¨æ„äº‹é¡¹
 * ----------------|-------------------------------|---------------------------
 * Hugepages       | æä¾›è¿ç»­ DMA å†…å­˜             | å¿…é¡»æå‰åˆ†é…ï¼Œå¦åˆ™ EAL åˆå§‹åŒ–æŠ¥é”™
 * ç½‘å£ç»‘å®š        | è§£é™¤å†…æ ¸é©±åŠ¨ï¼Œç»‘å®š PMD        | æ²¡ç»‘å®šï¼ŒPMD æ— æ³•æ¢æµ‹ç½‘å¡
 * PMD é©±åŠ¨        | ç”¨æˆ·æ€è½®è¯¢ç½‘å¡æ”¶å‘            | ç½‘å¡å‹å·ä¸åŒï¼ŒPMD ä¸åŒï¼ˆi40e/igb/virtioï¼‰
 * NUMA            | ä¼˜åŒ– CPU-å†…å­˜-ç½‘å¡è®¿é—®        | å¤šèŠ‚ç‚¹éœ€ç»‘å®šçº¿ç¨‹ & é˜Ÿåˆ—åˆ°ç½‘å¡æ‰€åœ¨ NUMA
 * Mbuf å†…å­˜æ±      | å­˜æ”¾æ•°æ®åŒ…                     | åˆ†é…åœ¨æœ¬åœ° NUMA èŠ‚ç‚¹ Hugepages
 * ä¸»å¾ªç¯          | æ”¶å‘åŒ…                         | è½®è¯¢æ–¹å¼ï¼Œæ²¡æœ‰ä¸­æ–­ï¼ŒCPU 100% å·¥ä½œ
 *
 *
 * âœ… æ€»ç»“ï¼š
 * - æ‰§è¡Œ dpdk-testpmd å‰ï¼š
 *   1. åˆ†é… Hugepages
 *   2. ç»‘å®šç½‘å¡åˆ°ç”¨æˆ·æ€é©±åŠ¨
 *   3. å¯é€‰ï¼šç¡®å®š CPU & NUMA é…ç½®
 * - testpmd åˆå§‹åŒ–ï¼š
 *   1. EAL åˆå§‹åŒ–ï¼ˆHugepages + PCI + NUMA + PMD é©±åŠ¨ï¼‰
 *   2. ç½‘å¡æ¢æµ‹
 *   3. å†…å­˜æ± åˆ›å»º
 *   4. é˜Ÿåˆ—é…ç½® & ç«¯å£å¯åŠ¨
 * - ä¸»å¾ªç¯ï¼š
 *   æ”¶åŒ… â†’ å‘åŒ… â†’ å¾ªç¯
 *   ä½¿ç”¨ mbuf å†…å­˜æ± é‡Œçš„å¤§é¡µï¼Œé¿å…è·¨ NUMA èŠ‚ç‚¹è®¿é—®
 */
```

### 9. å†è°ˆå¤§é¡µæ–‡ä»¶ç³»ç»Ÿ

```c
// æ–‡ä»¶ç³»ç»ŸæŒ‚è½½
xm@xm-virtual-machine:~/xx_dpdk/dpdk/build/app$ mount | grep huge
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime,pagesize=2M)


// åº”ç”¨ä½¿ç”¨å¤§é¡µå†…å­˜ä¸¾ä¾‹
#include <fcntl.h>
#include <sys/mman.h>
#include <unistd.h>
#include <stdio.h>

int main() {
    // æ‰“å¼€æ–‡ä»¶
    int fd = open("/dev/hugepages/myhugepagefile", O_CREAT | O_RDWR, 0755);
    if (fd < 0) { perror("open"); return 1; }

    // æ˜ å°„ 2MB å†…å­˜
    size_t size = 2 * 1024 * 1024;
    void* addr = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if (addr == MAP_FAILED) { perror("mmap"); return 1; }

    // ä½¿ç”¨å†…å­˜
    sprintf((char*)addr, "Hello hugepage!\n");
    printf("%s", (char*)addr);

    // è§£é™¤æ˜ å°„
    munmap(addr, size);
    close(fd);
    return 0;
}
```

### 10. testpmd è‡ªæµ‹

```c
sudo ./build/app/dpdk-testpmd -l 0-1 -n 4 \
  --vdev=net_pcap0,iface=lo \
  --vdev=net_pcap1,iface=lo \
  --no-pci \
  -- -i --forward-mode=io --port-topology=chained --auto-start


```